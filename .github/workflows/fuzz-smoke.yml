name: fuzz-smoke

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "fuzz/**"
      - "core/**"
      - "openai/**"
      - "anthropic/**"
      - ".github/workflows/fuzz-smoke.yml"

permissions:
  contents: read

jobs:
  fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install nightly Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-fuzz
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-fuzz

      - name: Run provider JSON fuzz smoke
        shell: bash
        run: |
          HOST_TARGET="$(rustc -vV | sed -n 's/^host: //p')"
          cargo fuzz run provider_stream_json --fuzz-dir fuzz --target "$HOST_TARGET" --sanitizer none -- -runs=0 -max_total_time=60

      - name: Run core event stream fuzz smoke
        shell: bash
        run: |
          HOST_TARGET="$(rustc -vV | sed -n 's/^host: //p')"
          cargo fuzz run core_event_stream --fuzz-dir fuzz --target "$HOST_TARGET" --sanitizer none -- -runs=0 -max_total_time=60
